name: 'Lighthouse (Production)'

on:
  push:
    branches: [main]
    paths-ignore: ['**.md', 'docs/**']
  workflow_dispatch:
  schedule:
    - cron: '0 5 * * *'

concurrency:
  group: lhci-main
  cancel-in-progress: true

env:
  NODE_VERSION: '22'

permissions:
  contents: read
  issues: write

jobs:
  lighthouse:
    name: 'Lighthouse CI (Production) â€“ ${{ matrix.formFactor }}'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      matrix:
        formFactor: [mobile, desktop]

    steps:
      - name: 'ðŸ”„ Checkout repository'
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: 'ðŸ”§ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: 'ðŸ§ª Test production URL accessibility'
        run: |
          urls=( "https://leenders-coaching.vercel.app/"
                 "https://leenders-coaching.vercel.app/over-mij"
                 "https://leenders-coaching.vercel.app/aanpak"
                 "https://leenders-coaching.vercel.app/coaching"
                 "https://leenders-coaching.vercel.app/contact" )

          echo "ðŸ” Testing production URL accessibility for all pages:"

          for production_url in "${urls[@]}"; do
            echo "  Testing: $production_url"
            
            # Test production URL accessibility (should not need authentication)
            response=$(curl -sL --max-time 30 --max-redirs 5 "$production_url" || echo "CURL_FAILED")
            final_url=$(curl -sLI --max-time 30 --max-redirs 5 "$production_url" 2>/dev/null | grep -i "^location:" | tail -1 | cut -d' ' -f2- | tr -d '\r\n' || echo "NO_REDIRECT")

            if [[ "$response" == "CURL_FAILED" ]]; then
              echo "âŒ Production URL is not accessible (network error)"
              echo "   URL: $production_url"
              exit 1
            else
              # Check HTTP status code
              code=$(curl -s -o /dev/null -w "%{http_code}" "$production_url")
              if [[ "$code" -ge 200 ]] && [[ "$code" -lt 400 ]]; then
                echo "âœ… HTTP $code - accessible"
              else
                echo "âš ï¸ Production URL returns HTTP $code"
                echo "   URL: $production_url"
                exit 1
              fi
            fi
          done

          echo "ðŸŽ¯ All production pages are accessible and ready for Lighthouse testing"

      - name: 'ðŸš€ Run Lighthouse CI (Production)'
        id: lhci
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: |
            https://leenders-coaching.vercel.app/
            https://leenders-coaching.vercel.app/over-mij
            https://leenders-coaching.vercel.app/aanpak
            https://leenders-coaching.vercel.app/coaching
            https://leenders-coaching.vercel.app/contact
          configPath: packages/leenders-coaching-nl/lighthouserc.ci.cjs
          budgetPath: packages/leenders-coaching-nl/budget.json
          uploadArtifacts: true
          artifactName: lighthouse-${{ matrix.formFactor }}
          temporaryPublicStorage: true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          LHCI_FORM_FACTOR: ${{ matrix.formFactor }}
          # OPTIONAL: If you run a private LHCI server, uncomment these:
          # LHCI_SERVER_BASE_URL: ${{ secrets.LHCI_SERVER_URL }}
          # LHCI_TOKEN: ${{ secrets.LHCI_SERVER_BUILD_TOKEN }}

      - name: 'ðŸ“Š Summarize key scores'
        if: always()
        run: |
          set -e
          sudo apt-get update -y >/dev/null 2>&1 || true
          sudo apt-get install -y jq >/dev/null 2>&1 || true
          results_dir="${{ steps.lhci.outputs.resultsPath }}"
          file="$results_dir/assertion-results.json"
          if [ ! -f "$file" ]; then
            echo "No assertion-results.json"; exit 0
          fi

          getScore () { jq -r '[.[] | select(.auditId == "categories:'"$1"'")] | if length>0 then .[0].actual else "N/A" end' "$file"; }
          fmtPct () {
            if [ "$1" = "N/A" ]; then
              echo "N/A"
            else
              awk -v v="$1" 'BEGIN{printf "%.0f/100", v*100}'
            fi
          }

          perf=$(getScore performance); a11y=$(getScore accessibility); seo=$(getScore seo); bp=$(getScore best-practices)

          echo "## ðŸš€ Production Lighthouse â€“ ${{ matrix.formFactor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Score |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| Performance | $(fmtPct "$perf") |" >> $GITHUB_STEP_SUMMARY
          echo "| Accessibility | $(fmtPct "$a11y") |" >> $GITHUB_STEP_SUMMARY
          echo "| SEO | $(fmtPct "$seo") |" >> $GITHUB_STEP_SUMMARY
          echo "| Best Practices | $(fmtPct "$bp") |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.lhci.outputs.links }}" ]; then
            first_url=$(echo '${{ steps.lhci.outputs.links }}' | jq -r 'values[0]' 2>/dev/null || echo '${{ steps.lhci.outputs.links }}')
            echo "- Temporary public report: ${first_url}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: 'ðŸš¨ Open regression issue when failed'
        if: failure() && github.event_name != 'schedule'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = `Lighthouse regression on main â€“ ${{ matrix.formFactor }} (${new Date().toISOString().slice(0,10)})`;
            const body = `The production Lighthouse check failed for **${{ matrix.formFactor }}**.

            Commit: \`${{ github.sha }}\`
            Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Please review the artifacts and the temporary report link in the job summary.`;
            await github.rest.issues.create({ owner: context.repo.owner, repo: context.repo.repo, title, body, labels: ['performance','lighthouse'] });
