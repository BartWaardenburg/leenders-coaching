name: 'Quality Gates & Security'

on:
  schedule:
    - cron: '0 6 * * *'
  push:
    branches: ['main']
    paths:
      - '**/package.json'
      - 'pnpm-lock.yaml'
  pull_request:
    branches: ['main', 'develop']
    paths:
      - '**/package.json'
      - 'pnpm-lock.yaml'
  workflow_dispatch:
    inputs:
      severity:
        description: 'Minimum severity level for security audit'
        required: false
        default: 'moderate'
        type: choice
        options:
          - 'info'
          - 'low'
          - 'moderate'
          - 'high'
          - 'critical'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: read

env:
  NODE_VERSION: '22'
  PNPM_VERSION: '10.15.1'
  PNPM_HOME: /home/runner/.local/share/pnpm

jobs:
  security-audit:
    name: 'Security Audit'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      vulnerabilities-found: ${{ steps.audit.outputs.vulnerabilities }}

    steps:
      - name: '🔄 Checkout repository'
        uses: actions/checkout@v5

      - name: '🔧 Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: '📦 Setup pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: 'Get pnpm store path'
        run: echo "PNPM_STORE_PATH=$(pnpm store path)" >> $GITHUB_ENV

      - name: '💾 Cache pnpm store'
        uses: actions/cache@v4
        with:
          path: ${{ env.PNPM_STORE_PATH }}
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: '📥 Install dependencies'
        run: pnpm run ci:install:frozen

      - name: '🔒 Run security audit'
        id: audit
        run: |
          command -v jq >/dev/null 2>&1 || { sudo apt-get update -y >/dev/null 2>&1 && sudo apt-get install -y jq >/dev/null 2>&1; }
          SEVERITY="${{ github.event.inputs.severity }}"
          : "${SEVERITY:=moderate}"   # default to moderate if not provided
          if pnpm audit --recursive --audit-level "$SEVERITY" --json > audit-results.json 2>/dev/null; then
            echo "vulnerabilities=false" >> $GITHUB_OUTPUT
            echo "info=0" >> $GITHUB_OUTPUT
            echo "low=0" >> $GITHUB_OUTPUT
            echo "moderate=0" >> $GITHUB_OUTPUT
            echo "high=0" >> $GITHUB_OUTPUT
            echo "critical=0" >> $GITHUB_OUTPUT
          else
            echo "vulnerabilities=true" >> $GITHUB_OUTPUT
            if [ -f audit-results.json ]; then
              INFO=$(jq -r '.metadata.vulnerabilities.info // 0' < audit-results.json)
              LOW=$(jq -r '.metadata.vulnerabilities.low // 0' < audit-results.json)
              MODERATE=$(jq -r '.metadata.vulnerabilities.moderate // 0' < audit-results.json)
              HIGH=$(jq -r '.metadata.vulnerabilities.high // 0' < audit-results.json)
              CRITICAL=$(jq -r '.metadata.vulnerabilities.critical // 0' < audit-results.json)
              echo "info=$INFO" >> $GITHUB_OUTPUT
              echo "low=$LOW" >> $GITHUB_OUTPUT
              echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
              echo "high=$HIGH" >> $GITHUB_OUTPUT
              echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
            fi
          fi
        continue-on-error: true

      - name: '📤 Upload audit results'
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-audit-${{ github.sha }}
          path: audit-results.json
          retention-days: 30

      - name: '📊 Generate security report'
        if: steps.audit.outputs.vulnerabilities == 'true' && github.event_name == 'pull_request'
        id: build_audit_md
        run: |
          command -v jq >/dev/null 2>&1 || { sudo apt-get update -y >/dev/null 2>&1 && sudo apt-get install -y jq >/dev/null 2>&1; }
          [ -f audit-results.json ] || { echo "No audit-results.json found"; exit 0; }

          # Summary counts (fallback to 0 if missing)
          VULN_SUMMARY="$(jq -r '
            .metadata.vulnerabilities as $m
            | "**Vulnerabilities Found:**\n- Info: \($m.info // 0)\n- Low: \($m.low // 0)\n- Moderate: \($m.moderate // 0)\n- High: \($m.high // 0)\n- Critical: \($m.critical // 0)"
          ' audit-results.json)"

          # Prefer .advisories (npm v6 / pnpm style). Fallback to .vulnerabilities (npm v7+ style).
          if jq -e '.advisories and (.advisories|length>0)' audit-results.json >/dev/null; then
            jq -r '
              .advisories
              | to_entries
              | sort_by([
                (if .value.severity == "critical" then 0 elif .value.severity == "high" then 1 elif .value.severity == "moderate" then 2 elif .value.severity == "low" then 3 else 4 end),
                .value.module_name
              ])
              | map(
                  "<details><summary><b>\(.value.title)</b> — \(.value.severity) — <code>\(.value.module_name)</code></summary>\n\n" +
                  "- **CVE:** \((.value.cves // []) | join(", ") | if . == "" then "—" else . end)\n" +
                  "- **Vulnerable Versions:** \(.value.vulnerable_versions)\n" +
                  "- **Patched Versions:** \(.value.patched_versions)\n" +
                  "- **Recommendation:** \(.value.recommendation)\n" +
                  "- **Overview:** \((.value.overview // "" | split("\n") | .[0:3] | join("\n")))\n" +
                  "- **References:** \(.value.url)\n" +
                  "- **Affected Paths (first 10):**\n" +
                  ( .value.findings | map(.paths) | add | unique | .[0:10] | map("  - " + .) | join("\n") ) + "\n" +
                  "</details>\n"
                )
              | .[]
            ' audit-results.json > VULN_DETAILS.md
          elif jq -e '.vulnerabilities and (.vulnerabilities|length>0)' audit-results.json >/dev/null; then
            jq -r '
              .vulnerabilities
              | to_entries
              | sort_by([
                (if .value.severity == "critical" then 0 elif .value.severity == "high" then 1 elif .value.severity == "moderate" then 2 elif .value.severity == "low" then 3 else 4 end),
                .key
              ])
              | map(
                  "<details><summary><b>\(.key)</b> — \(.value.severity) — range: <code>\(.value.range // "n/a")</code></summary>\n\n" +
                  "- **Via:** " +
                  ( .value.via
                    | map( if type=="string" then . else ( (.name // "") + (if .url then " ("+.url+")" else "" end) ) end )
                    | unique | join(", ")
                  ) + "\n" +
                  "- **Fix Available:** \(.value.fixAvailable // false)\n" +
                  "- **Paths (first 10):**\n" +
                  ( .value.nodes // [] | .[0:10] | map("  - " + .) | join("\n") ) + "\n" +
                  "</details>\n"
                )
              | .[]
            ' audit-results.json > VULN_DETAILS.md
          else
            echo "_No detailed advisories in audit output._" > VULN_DETAILS.md
          fi

          {
            echo "## 🔒 Security Audit Report"
            echo
            echo "⚠️ **Security vulnerabilities detected in dependencies**"
            echo
            echo "$VULN_SUMMARY"
            echo
            echo "### 📋 Detailed Findings"
            echo
            cat VULN_DETAILS.md
            echo
            echo "### 🔧 Next Steps"
            echo
            echo "1. **Review** the vulnerabilities and assess impact"
            echo "2. **Update** to patched versions where possible"
            echo "3. Consider enabling **Renovate/Dependabot**"
            echo "4. **Re-run** the audit after updates"
            echo
            echo "---"
            echo "*Generated by GitHub Actions Security Audit*"
          } > security-report.md

          # Safety: trim if close to GitHub's ~65k comment limit
          BYTES=$(wc -c < security-report.md | tr -d " ")
          if [ "$BYTES" -gt 60000 ]; then
            echo -e "\n> ⚠️ Report truncated due to GitHub comment size limits. See the full JSON in the workflow artifact." >> security-report.md
            head -c 60000 security-report.md > security-report.md.trim && mv security-report.md.trim security-report.md
          fi

      - name: '📤 Upload security report (non-PR)'
        if: steps.audit.outputs.vulnerabilities == 'true' && github.event_name != 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: security-report-${{ github.sha }}
          path: security-report.md
          retention-days: 30

      - name: '💬 Sticky PR comment – Security Audit'
        if: steps.audit.outputs.vulnerabilities == 'true' && github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          header: security-audit
          path: security-report.md

  license-compliance:
    name: 'License Compliance'
    runs-on: ubuntu-latest
    timeout-minutes: 8

    steps:
      - name: '🔄 Checkout repository'
        uses: actions/checkout@v5

      - name: '🔧 Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: '📦 Setup pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: 'Get pnpm store path'
        run: echo "PNPM_STORE_PATH=$(pnpm store path)" >> $GITHUB_ENV

      - name: '💾 Cache pnpm store'
        uses: actions/cache@v4
        with:
          path: ${{ env.PNPM_STORE_PATH }}
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: '📥 Install dependencies'
        run: pnpm run ci:install:frozen

      - name: '📜 Generate license report'
        run: |
          npx license-checker --summary > license-summary.txt || echo "License checker not available, skipping..."

          if [ -f license-summary.txt ]; then
            cat license-summary.txt
          fi

      - name: '📤 Upload license report'
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: license-report-${{ github.sha }}
          path: license-summary.txt
          retention-days: 30

  dependency-analysis:
    name: 'Dependency Analysis'
    runs-on: ubuntu-latest
    timeout-minutes: 12

    steps:
      - name: '🔄 Checkout repository'
        uses: actions/checkout@v5

      - name: '🔧 Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: '📦 Setup pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: 'Get pnpm store path'
        run: echo "PNPM_STORE_PATH=$(pnpm store path)" >> $GITHUB_ENV

      - name: '💾 Cache pnpm store'
        uses: actions/cache@v4
        with:
          path: ${{ env.PNPM_STORE_PATH }}
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: '📥 Install dependencies'
        run: pnpm run ci:install:frozen

      - name: '📊 Analyze dependencies'
        run: |
          sudo apt-get update -y >/dev/null 2>&1 || true
          sudo apt-get install -y jq >/dev/null 2>&1 || true
          echo "📦 Dependency Analysis Report"
          echo "=========================="

          pnpm run outdated || echo "✅ All packages are up to date"

          echo ""
          echo "📈 Package count by workspace:"
          echo "Root: $(cat package.json | jq '.devDependencies | length')"
          echo "Frontend: $(cat packages/leenders-coaching-nl/package.json | jq '.dependencies | length')"
          echo "Studio: $(cat packages/studio-leenders-coaching-nl/package.json | jq '.dependencies | length')"

      - name: '🔍 Check for duplicate dependencies'
        run: pnpm run dedupe:check || echo "ℹ️ Some dependencies could be deduplicated"

      - name: '📊 Generate dependency tree'
        run: pnpm list --depth=2 > dependency-tree.txt || echo "Dependency tree generated with warnings"

      - name: '📤 Upload dependency analysis'
        uses: actions/upload-artifact@v4
        with:
          name: dependency-analysis-${{ github.sha }}
          path: dependency-tree.txt
          retention-days: 30

  code-quality:
    name: 'Code Quality Metrics'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
      NEXT_PUBLIC_SANITY_DATASET: ${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}
      NEXT_PUBLIC_SANITY_API_VERSION: ${{ secrets.NEXT_PUBLIC_SANITY_API_VERSION }}
      SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}

    steps:
      - name: '🔄 Checkout repository'
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: '🔧 Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: '📦 Setup pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: 'Get pnpm store path'
        run: echo "PNPM_STORE_PATH=$(pnpm store path)" >> $GITHUB_ENV

      - name: '💾 Cache pnpm store'
        uses: actions/cache@v4
        with:
          path: ${{ env.PNPM_STORE_PATH }}
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: '📥 Install dependencies'
        run: pnpm run ci:install:frozen

      - name: '🔍 ESLint analysis'
        run: |
          sudo apt-get update -y >/dev/null 2>&1 || true
          sudo apt-get install -y jq >/dev/null 2>&1 || true
          if pnpm --filter leenders-coaching-nl run lint:format > eslint-raw-output.txt 2>&1; then
            ESLINT_STATUS="success"
          else
            ESLINT_STATUS="issues"
          fi

          if [ -f eslint-raw-output.txt ]; then
            sed -n '/^\[/,$p' eslint-raw-output.txt > eslint-results.json
            
            if jq empty eslint-results.json 2>/dev/null; then
              TOTAL_FILES=$(cat eslint-results.json | jq 'length')
              ERROR_COUNT=$(cat eslint-results.json | jq 'map(.errorCount) | add // 0')
              WARNING_COUNT=$(cat eslint-results.json | jq 'map(.warningCount) | add // 0')
              
              echo "Files analyzed: $TOTAL_FILES"
              echo "Total errors: $ERROR_COUNT"
              echo "Total warnings: $WARNING_COUNT"
              
              if [ "$ERROR_COUNT" -gt 0 ] || [ "$WARNING_COUNT" -gt 0 ]; then
                echo ""
                echo "Files with issues:"
                cat eslint-results.json | jq -r '.[] | select(.errorCount > 0 or .warningCount > 0) | "  - \(.filePath | split("/") | last): \(.errorCount) errors, \(.warningCount) warnings"'
              fi
            fi
          fi

      - name: '📊 TypeScript strict check'
        run: pnpm --parallel run type-check 2>&1 | tee typescript-results.txt || echo "TypeScript issues found"

      - name: '📈 Code complexity analysis'
        run: pnpm dlx complexity-report --output json --format json packages/*/src | sort -nr -k2 > complexity-analysis.txt

      - name: '📤 Upload quality metrics'
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-quality-${{ github.sha }}
          path: |
            eslint-results.json
            typescript-results.txt
            complexity-analysis.txt
          retention-days: 30

  performance-benchmarks:
    name: 'Performance Benchmarks'
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.ref == 'refs/heads/main'
    timeout-minutes: 20

    env:
      NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
      NEXT_PUBLIC_SANITY_DATASET: ${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}
      NEXT_PUBLIC_SANITY_API_VERSION: ${{ secrets.NEXT_PUBLIC_SANITY_API_VERSION }}
      SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}

    steps:
      - name: '🔄 Checkout repository'
        uses: actions/checkout@v5

      - name: '🔧 Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: '📦 Setup pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: 'Get pnpm store path'
        run: echo "PNPM_STORE_PATH=$(pnpm store path)" >> $GITHUB_ENV

      - name: '💾 Cache pnpm store'
        uses: actions/cache@v4
        with:
          path: ${{ env.PNPM_STORE_PATH }}
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: '📥 Install dependencies'
        run: pnpm run ci:install:frozen

      - name: '⏱️ Build time benchmark'
        run: |
          start_time=$(date +%s)
          pnpm run build:frontend
          end_time=$(date +%s)
          frontend_duration=$((end_time - start_time))
          echo "Frontend build: ${frontend_duration}s"

          start_time=$(date +%s)
          pnpm run build:studio
          end_time=$(date +%s)
          studio_duration=$((end_time - start_time))
          echo "Studio build: ${studio_duration}s"

          echo "{\"frontend_build_time\": $frontend_duration, \"studio_build_time\": $studio_duration}" > build-metrics.json

      - name: '📊 Bundle size analysis'
        run: pnpm --filter ./packages/leenders-coaching-nl run analyze:bundle

      - name: '🔍 Performance audit (non-Lighthouse)'
        run: pnpm --filter ./packages/leenders-coaching-nl run verify:performance

      - name: '📋 Capture bundle size summary'
        run: |
          if [ -d "packages/leenders-coaching-nl/.next" ]; then
            if [ -d "packages/leenders-coaching-nl/.next/static/chunks" ]; then
              echo "📊 Chunk Statistics:"
              echo "Total JS chunks: $(find packages/leenders-coaching-nl/.next/static/chunks -name "*.js" | wc -l)"
              echo "Total CSS files: $(find packages/leenders-coaching-nl/.next/static/css -name "*.css" | wc -l)"
              
              JS_SIZE=$(find packages/leenders-coaching-nl/.next/static/chunks -name "*.js" -exec du -ch {} + | tail -1 | cut -f1)
              CSS_SIZE=$(find packages/leenders-coaching-nl/.next/static/css -name "*.css" -exec du -ch {} + | tail -1 | cut -f1)
              
              echo "Total JS size: $JS_SIZE"
              echo "Total CSS size: $CSS_SIZE"
            fi
            
            echo "📏 Bundle size limits are enforced by the Size Limit GitHub Action on PRs"
            
            if [ -d "packages/leenders-coaching-nl/.next/analyze" ]; then
              echo "📁 Bundle analysis files available in packages/leenders-coaching-nl/.next/analyze/"
              ls -la packages/leenders-coaching-nl/.next/analyze/ || echo "No analysis files found"
            fi
          else
            exit 1
          fi

      - name: '📤 Upload performance metrics'
        uses: actions/upload-artifact@v4
        with:
          name: performance-metrics-${{ github.sha }}
          path: |
            build-metrics.json
            packages/leenders-coaching-nl/.next/static/
          retention-days: 90

  quality-summary:
    name: 'Quality Summary'
    runs-on: ubuntu-latest
    needs:
      [security-audit, license-compliance, dependency-analysis, code-quality]
    if: always()
    timeout-minutes: 5

    steps:
      - name: '📋 Generate quality report'
        run: |
          echo "## 🎯 Quality Gates Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.security-audit.outputs.vulnerabilities-found }}" = "true" ]; then
            echo "- ⚠️ **Security**: Vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ✅ **Security**: No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "- ${{ needs.license-compliance.result == 'success' && '✅' || '❌' }} **License Compliance**: ${{ needs.license-compliance.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ${{ needs.dependency-analysis.result == 'success' && '✅' || '❌' }} **Dependency Analysis**: ${{ needs.dependency-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ${{ needs.code-quality.result == 'success' && '✅' || '❌' }} **Code Quality**: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: '💬 Sticky PR comment – Quality Gates'
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          header: quality-gates
          number: ${{ github.event.pull_request.number }}
          message: |
            ## 🎯 Quality Gates (summary)
            - **Security:** ${{ needs.security-audit.outputs.vulnerabilities-found == 'true' && '⚠️ Vulnerabilities detected' || '✅ No vulnerabilities found' }}
            - **License Compliance:** ${{ needs.license-compliance.result == 'success' && '✅' || '❌' }}
            - **Dependency Analysis:** ${{ needs.dependency-analysis.result == 'success' && '✅' || '❌' }}
            - **Code Quality:** ${{ needs.code-quality.result == 'success' && '✅' || '❌' }}

            _This comment updates automatically on new commits to this PR._

      - name: '🚨 Fail on critical issues'
        if: needs.security-audit.outputs.vulnerabilities-found == 'true' && github.event.inputs.severity == 'critical'
        run: |
          echo "❌ Critical security vulnerabilities found!"
          exit 1
