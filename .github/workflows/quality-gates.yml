name: 'Quality Gates & Security'

on:
  schedule:
    - cron: '0 6 * * *'
  push:
    branches: ['main']
    paths:
      - '**/package.json'
      - 'pnpm-lock.yaml'
  pull_request:
    branches: ['main']
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      severity:
        description: 'Minimum severity level for security audit'
        required: false
        default: 'moderate'
        type: choice
        options: ['info', 'low', 'moderate', 'high', 'critical']

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: read

jobs:
  security-audit:
    name: 'Security Audit'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      vulnerabilities-found: ${{ steps.audit.outputs.vulnerabilities }}

    steps:
      - name: 'üîÑ Checkout repository'
        uses: actions/checkout@v5

      - name: '‚öôÔ∏è Setup Environment'
        uses: ./.github/actions/setup
        with:
          node-version: '22'
          pnpm-version: '10.15.1'
          working-directory: ''

      - name: 'üîí Run security audit'
        id: audit
        run: |
          command -v jq >/dev/null 2>&1 || { sudo apt-get update -y >/dev/null 2>&1 && sudo apt-get install -y jq >/dev/null 2>&1; }
          SEVERITY="${{ github.event.inputs.severity }}"
          : "${SEVERITY:=moderate}"

          # Run audit and capture results
          pnpm audit --audit-level "$SEVERITY" --json > audit-results.json 2>&1
          AUDIT_EXIT_CODE=$?

          # Check if there are actual vulnerabilities at/above threshold
          if [ -f audit-results.json ]; then
            # Use jq to check if there are vulnerabilities at or above the threshold
            case "$SEVERITY" in
              "critical")
                VULN_COUNT=$(jq -r '.metadata.vulnerabilities.critical // 0' audit-results.json)
                ;;
              "high")
                VULN_COUNT=$(jq -r '(.metadata.vulnerabilities.critical // 0) + (.metadata.vulnerabilities.high // 0)' audit-results.json)
                ;;
              "moderate")
                VULN_COUNT=$(jq -r '(.metadata.vulnerabilities.critical // 0) + (.metadata.vulnerabilities.high // 0) + (.metadata.vulnerabilities.moderate // 0)' audit-results.json)
                ;;
              "low")
                VULN_COUNT=$(jq -r '(.metadata.vulnerabilities.critical // 0) + (.metadata.vulnerabilities.high // 0) + (.metadata.vulnerabilities.moderate // 0) + (.metadata.vulnerabilities.low // 0)' audit-results.json)
                ;;
              *)
                VULN_COUNT=0
                ;;
            esac
            
            if [ "$VULN_COUNT" -gt 0 ]; then
              echo "vulnerabilities=true" >> $GITHUB_OUTPUT
            else
              echo "vulnerabilities=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "vulnerabilities=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: 'üì§ Upload audit results'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-${{ github.sha }}
          path: audit-results.json
          retention-days: 30

      - name: 'üìä Build compact security report (PRs)'
        if: github.event_name == 'pull_request'
        run: |
          command -v jq >/dev/null 2>&1 || sudo apt-get install -y jq >/dev/null 2>&1
          [ -f audit-results.json ] || echo '{}' > audit-results.json

          THRESHOLD="${{ github.event.inputs.severity || 'moderate' }}"
          COUNTS_JSON=$(jq -r '.metadata.vulnerabilities // {}' audit-results.json)
          CRIT=$(echo "$COUNTS_JSON" | jq -r '.critical // 0')
          HIGH=$(echo "$COUNTS_JSON" | jq -r '.high // 0')
          MOD=$(echo "$COUNTS_JSON" | jq -r '.moderate // 0')
          LOW=$(echo "$COUNTS_JSON" | jq -r '.low // 0')

          {
            echo "## üîí Security Audit"
            if [ "${{ steps.audit.outputs.vulnerabilities }}" = "true" ]; then
              echo "**Status:** ‚ö†Ô∏è Action required (threshold: \`$THRESHOLD\`)"
            else
              # No findings at/above threshold ‚Äî still show low count if present
              if [ "$LOW" -gt 0 ]; then
                echo "**Status:** ‚úÖ No actionable vulnerabilities. _($LOW low issues present)_"
              else
                echo "**Status:** ‚úÖ No vulnerabilities found."
              fi
            fi
            echo
            echo "| Severity | Count |"
            echo "|---|---:|"
            echo "| Critical | $CRIT |"
            echo "| High | $HIGH |"
            echo "| Moderate | $MOD |"
            echo "| Low | $LOW |"

            # Show actionable items (at/above threshold) - top 10
            if jq -e '.advisories' audit-results.json >/dev/null 2>&1; then
              # Get all advisories at or above the threshold
              ACT=$(jq --arg threshold "$THRESHOLD" '
                .advisories
                | to_entries
                | map(.value)
                | map(select(
                  ($threshold == "critical" and .severity == "critical") or
                  ($threshold == "high" and (.severity == "critical" or .severity == "high")) or
                  ($threshold == "moderate" and (.severity == "critical" or .severity == "high" or .severity == "moderate")) or
                  ($threshold == "low" and (.severity == "critical" or .severity == "high" or .severity == "moderate" or .severity == "low")) or
                  ($threshold == "info")
                ))
                | .[0:10]
              ' audit-results.json)

              if [ "$(echo "$ACT" | jq 'length')" -gt 0 ]; then
                echo
                echo "### ‚ö†Ô∏è Vulnerabilities requiring attention"
                echo
                echo "| Module | Current | Patched | Severity | Description |"
                echo "|---|---|---|---|---|"
                echo "$ACT" | jq -r '.[] | "| `" + .module_name + "` | " + (.findings[0].version // "?") + " | `" + (.patched_versions // "N/A") + "` | " + .severity + " | " + (.title // "advisory" | gsub("[\\n\\r\\t]"; " ")) + " |"'
                echo
                echo "_Apply updates with:_ \`pnpm up <module> -r\`"
              fi

              # Show low severity items separately if they exist
              if [ "$LOW" -gt 0 ]; then
                echo
                echo "### ‚ÑπÔ∏è Low priority updates (optional)"
                if [ "$LOW" -gt 1 ]; then
                  echo "_Note: Multiple findings may represent the same vulnerability affecting different package versions or paths_"
                  echo
                fi
                echo "| Module | Current | Patched | Description |"
                echo "|---|---|---|---|"
                # Show all findings for each advisory to account for multiple vulnerable packages
                jq -r '.advisories | to_entries | map(.value) | map(select(.severity == "low")) | .[0:5] | .[] | .findings[] as $finding | "| `" + .module_name + "` | " + ($finding.version // "?") + " | `" + (.patched_versions // "N/A") + "` | " + (.title // "advisory") + " |"' audit-results.json
              fi
            fi

            echo
            echo "*Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*"
          } > security-report.md

      - name: 'üí¨ Sticky PR comment ‚Äì Security'
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          header: security-audit
          number: ${{ github.event.pull_request.number }}
          path: security-report.md

  license-compliance:
    name: 'License Compliance'
    runs-on: ubuntu-latest
    timeout-minutes: 8
    steps:
      - uses: actions/checkout@v5

      - name: '‚öôÔ∏è Setup Environment'
        uses: ./.github/actions/setup
        with:
          node-version: '22'
          pnpm-version: '10.15.1'
          working-directory: ''

      - name: 'üìú Scan licenses (JSON)'
        run: |
          npx license-checker --json --production --relativeLicensePath > license.json || echo "{}" > license.json

      - name: 'üßæ Build compact license report (PRs)'
        if: github.event_name == 'pull_request'
        run: |
          command -v jq >/dev/null 2>&1 || sudo apt-get install -y jq >/dev/null 2>&1
          {
            echo "## üìú License Compliance"
            echo
            # Flag problematic licenses
            echo "### ‚ö†Ô∏è Flagged Licenses"
            PROBLEMATIC=$(jq -r '
              to_entries
              | map({pkg: .key, lic: (.value.licenses // "UNKNOWN")})
              | map(select(.lic|test("(GPL|AGPL|LGPL|SSPL|BUSL|Commons Clause)"; "i") or .lic=="UNKNOWN" or .lic|test("Proprietary"; "i")))
            ' license.json)
            
            if [ "$(echo "$PROBLEMATIC" | jq 'length')" -gt 0 ]; then
              echo "| Package | License | Risk Level |"
              echo "|---|---|---|"
              echo "$PROBLEMATIC" | jq -r '.[] | 
                if .lic|test("(GPL|AGPL|LGPL)"; "i") then "| `\(.pkg)` | `\(.lic)` | üî¥ High |"
                elif .lic|test("(SSPL|BUSL|Commons Clause)"; "i") then "| `\(.pkg)` | `\(.lic)` | üü° Medium |"
                elif .lic=="UNKNOWN" then "| `\(.pkg)` | `\(.lic)` | üü† Unknown |"
                else "| `\(.pkg)` | `\(.lic)` | üü° Medium |"
                end
              '
            else
              echo "‚úÖ No GPL/AGPL/LGPL/SSPL/BUSL/Commons-Clause/Proprietary/UNKNOWN licenses found."
            fi
          } > license-report.md

      - name: 'üí¨ Sticky PR comment ‚Äì Licenses'
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          header: license-compliance
          number: ${{ github.event.pull_request.number }}
          path: license-report.md

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: license-scan-${{ github.sha }}
          path: license.json
          retention-days: 30

  dependency-analysis:
    name: 'Dependency Analysis'
    runs-on: ubuntu-latest
    timeout-minutes: 12
    steps:
      - uses: actions/checkout@v5

      - name: '‚öôÔ∏è Setup Environment'
        uses: ./.github/actions/setup
        with:
          node-version: '22'
          pnpm-version: '10.15.1'
          working-directory: ''

      - name: 'üìä Outdated (JSON) + Dedupe'
        run: |
          # Check for outdated packages - handle both pnpm and npm
          if command -v pnpm >/dev/null 2>&1; then
            pnpm outdated --format json > outdated.json 2>/dev/null || echo "{}" > outdated.json
          else
            echo "{}" > outdated.json
          fi

          # Run dedupe check and capture output
          if command -v pnpm >/dev/null 2>&1; then
            pnpm dedupe --check 2>&1 | tee dedupe.txt || echo "No dedupe changes needed" > dedupe.txt
          else
            echo "pnpm not available" > dedupe.txt
          fi

      - name: 'üßæ Build compact deps report (PRs)'
        if: github.event_name == 'pull_request'
        run: |
          command -v jq >/dev/null 2>&1 || sudo apt-get install -y jq >/dev/null 2>&1
          {
            echo "## üì¶ Dependency Analysis"
            echo
            
            # Check if we have outdated packages
            OUTDATED_COUNT=$(jq 'length' outdated.json)
            if [ "$OUTDATED_COUNT" -gt 0 ]; then
              echo "### üîÑ Available Updates"
              echo "| Package | Current | Latest | Type | Priority |"
              echo "|---|---|---|---|---|"
              jq -r '
                to_entries
                | map({name: .key, cur: .value.current, lat: .value.latest, type: .value.bump})
                | sort_by(.type)             # patch -> minor -> major (lexicographically)
                | .[0:15]                    # Show top 15
                | .[]
                | "| `\(.name)` | \(.cur) | \(.lat) | \(.type // "n/a") | \(if .type == "patch" then "üü¢ Low" elif .type == "minor" then "üü° Medium" else "üî¥ High" end) |"'
              outdated.json
              echo
              echo "_Apply updates:_ \`pnpm up <package> -r\` or \`pnpm up -r\` for all"
            else
              echo "### üîÑ Available Updates"
              echo "‚úÖ All packages are up to date!"
            fi
            echo
            
            # Handle dedupe information
            if grep -q "Dedupe --check found changes" dedupe.txt; then
              echo "### üîó Lockfile Deduplication"
              echo "‚ö†Ô∏è **Changes detected:** The lockfile can be optimized by deduplicating packages."
              echo
              echo "**Summary of changes:**"
              echo '```text'
              # Extract the key changes from dedupe output
              grep -E "(‚Üí|‚Üí|‚Üí)" dedupe.txt | head -n 10 | sed 's/^/  /'
              echo '```'
              echo
              echo "_Apply optimization:_ \`pnpm dedupe && pnpm install\`"
            elif grep -q "No dedupe changes needed" dedupe.txt; then
              echo "### üîó Lockfile Deduplication"
              echo "‚úÖ Lockfile is already optimized - no deduplication needed."
            else
              echo "### üîó Lockfile Deduplication"
              echo "‚ÑπÔ∏è Dedupe check completed - no significant changes detected."
            fi
            
            # Show any warnings about deprecated packages
            if grep -q "deprecated" dedupe.txt; then
              echo
              echo "### ‚ö†Ô∏è Deprecated Packages"
              echo "The following packages are deprecated and should be updated:"
              echo '```text'
              grep -i "deprecated" dedupe.txt | head -n 5 | sed 's/^/  /'
              echo '```'
            fi
          } > dependency-report.md

      - name: 'üí¨ Sticky PR comment ‚Äì Dependencies'
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          header: dependency-analysis
          number: ${{ github.event.pull_request.number }}
          path: dependency-report.md

      - uses: actions/upload-artifact@v4
        with:
          name: dependency-artifacts-${{ github.sha }}
          path: |
            outdated.json
            dedupe.txt
          retention-days: 30

  code-quality:
    name: 'Code Quality'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: '‚öôÔ∏è Setup Environment'
        uses: ./.github/actions/setup
        with:
          node-version: '22'
          pnpm-version: '10.15.1'
          working-directory: ''

      - name: 'üßπ ESLint (json) / TS / Complexity'
        run: |
          sudo apt-get update -y >/dev/null 2>&1 || true
          sudo apt-get install -y jq >/dev/null 2>&1 || true
          pnpm --filter leenders-coaching-nl run lint:format > eslint-raw.txt 2>&1 || true
          sed -n '/^\[/,$p' eslint-raw.txt > eslint.json || echo "[]" > eslint.json
          pnpm --parallel run type-check 2>&1 | tee ts.txt || true

          # Create a simple complexity analysis using file sizes and line counts
          echo "[]" > complexity.json
          if command -v find >/dev/null 2>&1 && command -v wc >/dev/null 2>&1; then
            # Create a temporary file for building the JSON
            echo "[" > temp_complexity.json
            first=true
            find packages/*/src -name "*.ts" -o -name "*.tsx" | head -20 | while IFS= read -r file; do
              if [ -f "$file" ]; then
                lines=$(wc -l < "$file" | tr -d ' ')
                size=$(wc -c < "$file" | tr -d ' ')
                if [ "$first" = true ]; then
                  first=false
                else
                  echo "," >> temp_complexity.json
                fi
                echo "{\"file\":\"$file\",\"lines\":$lines,\"size\":$size,\"maintainability\":$((100 - lines/10)),\"complexity\":$((lines/20))}" >> temp_complexity.json
              fi
            done
            echo "]" >> temp_complexity.json
            mv temp_complexity.json complexity.json
          fi

      - name: 'üßæ Build compact code report (PRs)'
        if: github.event_name == 'pull_request'
        run: |
          command -v jq >/dev/null 2>&1 || sudo apt-get install -y jq >/dev/null 2>&1
          FILES=$(jq 'length' eslint.json)
          ERR=$(jq 'map(.errorCount)|add // 0' eslint.json)
          WARN=$(jq 'map(.warningCount)|add // 0' eslint.json)

          # Check complexity report
          COMPLEXITY_COUNT=$(jq 'length' complexity.json)

          {
            echo "## üßπ Code Quality"
            echo
            echo "**ESLint:** $ERR errors, $WARN warnings (across $FILES files)"
            if [ "$ERR" -gt 0 ] || [ "$WARN" -gt 0 ]; then
              echo
              echo "### üìã Top files with issues:"
              echo '```text'
              jq -r '.[] | select(.errorCount>0 or .warningCount>0) | "\(.filePath | split("/") | last): \(.errorCount) errors, \(.warningCount) warnings"' eslint.json | head -n 10
              echo '```'
            fi
            echo
            if grep -qiE "error|TS[0-9]{4}" ts.txt; then
              echo "**TypeScript:** issues detected (last 40 lines)"
              echo '```text'; tail -n 40 ts.txt; echo '```'
            else
              echo "**TypeScript:** ‚úÖ no issues."
            fi
            echo
            
            # Handle complexity report
            if [ "$COMPLEXITY_COUNT" -gt 0 ]; then
              echo "**Complexity Analysis:** $COMPLEXITY_COUNT files analyzed"
              echo
              echo "### üîç Maintainability Scores"
              echo "| File | Maintainability | Complexity | Halstead | LOC |"
              echo "|---|---|---|---|---|"
              jq -r '
                [.[] | {file: (.file | split("/") | last), maintainability, cyclomatic, halstead, loc}]
                | sort_by(.maintainability)
                | .[0:10]
                | .[]
                | "| `\(.file)` | \(.maintainability // "N/A") | \(.cyclomatic // "N/A") | \(.halstead // "N/A") | \(.loc // "N/A") |"
              ' complexity.json
              
              # Show high complexity files
              HIGH_COMPLEXITY=$(jq -r '
                [.[] | select(.cyclomatic > 10)]
                | sort_by(.cyclomatic)
                | reverse
                | .[0:5]
                | .[]
                | "\(.file | split("/") | last): \(.cyclomatic) complexity"
              ' complexity.json)
              
              if [ -n "$HIGH_COMPLEXITY" ]; then
                echo
                echo "### ‚ö†Ô∏è High Complexity Files (>10)"
                echo '```text'
                echo "$HIGH_COMPLEXITY"
                echo '```'
              fi
            else
              echo "**Complexity Analysis:** No complexity data available"
            fi
          } > code-quality.md

      - name: 'üí¨ Sticky PR comment ‚Äì Code Quality'
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          header: code-quality
          number: ${{ github.event.pull_request.number }}
          path: code-quality.md

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-quality-${{ github.sha }}
          path: |
            eslint.json
            ts.txt
            complexity.json
          retention-days: 30

  performance-benchmarks:
    name: 'Performance Benchmarks'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
      NEXT_PUBLIC_SANITY_DATASET: ${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}
      NEXT_PUBLIC_SANITY_API_VERSION: ${{ secrets.NEXT_PUBLIC_SANITY_API_VERSION }}
      SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
    steps:
      - uses: actions/checkout@v5

      - name: '‚öôÔ∏è Setup Environment'
        uses: ./.github/actions/setup
        with:
          node-version: '22'
          pnpm-version: '10.15.1'
          working-directory: ''

      # One build with analyzer ON (captures reports + sizes)
      - name: 'üèóÔ∏è Build (with bundle analyzer)'
        id: build_analyze
        run: |
          START=$(date +%s)
          pnpm --filter ./packages/leenders-coaching-nl run analyze:bundle
          END=$(date +%s)
          echo "duration=$((END-START))" >> $GITHUB_OUTPUT

      - name: 'üîç Size-Limit gate (does not fail PR comment)'
        continue-on-error: true
        run: pnpm --filter ./packages/leenders-coaching-nl run verify:performance:ci

      - name: 'üìä Bundle snapshot'
        id: bundle_snapshot
        run: |
          JS_SIZE=$(find packages/leenders-coaching-nl/.next/static/chunks -name "*.js" -exec du -ch {} + 2>/dev/null | tail -1 | cut -f1)
          CSS_SIZE=$(find packages/leenders-coaching-nl/.next/static/css -name "*.css" -exec du -ch {} + 2>/dev/null | tail -1 | cut -f1)
          echo "js=${JS_SIZE:-n/a}"   >> $GITHUB_OUTPUT
          echo "css=${CSS_SIZE:-n/a}" >> $GITHUB_OUTPUT

      - name: 'üßæ Build compact perf report (PRs)'
        if: github.event_name == 'pull_request'
        run: |
          {
            echo "## üöÄ Performance"
            echo
            echo "| Metric | Value |"
            echo "|---|---:|"
            echo "| Build (frontend, ANALYZE on) | ${{ steps.build_analyze.outputs.duration || 'n/a' }}s |"
            echo "| Total JS (chunks) | ${{ steps.bundle_snapshot.outputs.js || 'n/a' }} |"
            echo "| Total CSS | ${{ steps.bundle_snapshot.outputs.css || 'n/a' }} |"
            echo
            echo "üìä **Bundle Analysis:** HTML reports available in artifact \`bundle-analyzer-${{ github.sha }}\`"
          } > performance.md

      - name: 'üí¨ Sticky PR comment ‚Äì Performance'
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          header: performance-benchmarks
          number: ${{ github.event.pull_request.number }}
          path: performance.md

      - name: 'üìù Write perf.json (for artifact)'
        run: |
          printf '{"frontend":%s,"js":"%s","css":"%s"}\n' \
            "${{ steps.build_analyze.outputs.duration || 'null' }}" \
            "${{ steps.bundle_snapshot.outputs.js || 'n/a' }}" \
            "${{ steps.bundle_snapshot.outputs.css || 'n/a' }}" > perf.json

      - name: 'üì§ Upload bundle analyzer report'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analyzer-${{ github.sha }}
          path: packages/leenders-coaching-nl/.next/analyze/
          if-no-files-found: ignore # prevents failures when folder missing
          retention-days: 14

      - uses: actions/upload-artifact@v4
        with:
          name: performance-${{ github.sha }}
          path: perf.json
          retention-days: 90

  quality-summary:
    name: 'Quality Summary'
    runs-on: ubuntu-latest
    needs:
      [
        security-audit,
        license-compliance,
        dependency-analysis,
        code-quality,
        performance-benchmarks,
      ]
    if: always()
    steps:
      - name: 'üí¨ Sticky PR comment ‚Äì Quality Gates'
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          header: quality-gates
          number: ${{ github.event.pull_request.number }}
          message: |
            ## üéØ Quality Gates
            - **Security:** ${{ needs.security-audit.outputs.vulnerabilities-found == 'true' && '‚ö†Ô∏è Action required' || '‚úÖ Clear' }}
            - **Licenses:** ‚úÖ Scanned (see comment)
            - **Dependencies:** ‚úÖ Scanned (see comment)
            - **Code Quality:** ‚úÖ Scanned (see comment)
            - **Performance:** ‚úÖ Scanned (see comment)
