name: 'Bundle Size Analysis & Limits'

on:
  pull_request:
    branches: ['main']
    paths:
      - 'packages/leenders-coaching-nl/src/**'
      - 'packages/leenders-coaching-nl/package.json'
      - 'packages/leenders-coaching-nl/.size-limit.json'
      - 'packages/leenders-coaching-nl/next.config.ts'
      - 'packages/leenders-coaching-nl/tailwind.config.ts'
      - 'pnpm-lock.yaml'

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Setup environment
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v5
      - name: 'âš™ï¸ Setup Environment'
        uses: ./.github/actions/setup
        with:
          node-version: '22'
          pnpm-version: '10.15.1'
          working-directory: ''

  bundle-analysis:
    name: 'ðŸ“Š Bundle Size Analysis & Limits'
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 20

    env:
      NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
      NEXT_PUBLIC_SANITY_DATASET: ${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}
      NEXT_PUBLIC_SANITY_API_VERSION: ${{ secrets.NEXT_PUBLIC_SANITY_API_VERSION }}
      SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}

    steps:
      - name: 'ðŸ”„ Checkout repository'
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: 'âš™ï¸ Setup Environment'
        uses: ./.github/actions/setup
        with:
          node-version: '22'
          pnpm-version: '10.15.1'
          working-directory: ''

      - name: 'ðŸ—ï¸ Build frontend'
        run: pnpm --filter leenders-coaching-nl run build

      - name: 'ðŸ“Š Run Size Limit (soft-fail)'
        id: sizelimit
        working-directory: packages/leenders-coaching-nl
        run: |
          set -e
          mkdir -p .bundle-analysis
          set +e
          pnpm exec size-limit --json > .bundle-analysis/size-results.json
          code=$?
          echo "exit_code=$code" >> "$GITHUB_OUTPUT"
          # always succeed here; comments/summary will reflect pass/fail
          exit 0

      - name: 'â¬‡ï¸ Checkout main as baseline'
        uses: actions/checkout@v5
        with:
          ref: main
          path: baseline

      - name: 'âš™ï¸ Setup Environment (baseline)'
        uses: ./.github/actions/setup
        with:
          node-version: '22'
          pnpm-version: '10.15.1'
          working-directory: baseline

      - name: 'ðŸ—ï¸ Build frontend (baseline)'
        working-directory: baseline
        run: pnpm --filter leenders-coaching-nl run build

      - name: 'ðŸ“ Run size-limit (baseline)'
        working-directory: baseline/packages/leenders-coaching-nl
        env:
          NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
          NEXT_PUBLIC_SANITY_DATASET: ${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}
          NEXT_PUBLIC_SANITY_API_VERSION: ${{ secrets.NEXT_PUBLIC_SANITY_API_VERSION }}
          SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        run: |
          OUT="$GITHUB_WORKSPACE/packages/leenders-coaching-nl/.bundle-analysis/size-results-main.json"
          # Don't fail if baseline exceeds limits - we just want the measurements
          set +e
          pnpm exec size-limit --json > "$OUT" 2>/dev/null
          # Always exit successfully - we're just collecting baseline data
          exit 0

      - name: 'ðŸ” Generate Detailed Bundle Analysis (from JSON)'
        working-directory: packages/leenders-coaching-nl
        run: |
          node -e "
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('.bundle-analysis/size-results.json', 'utf8'));
            const cfg = JSON.parse(fs.readFileSync('.size-limit.json', 'utf8'));
            const cfgByName = new Map(cfg.map(c => [c.name, c]));

            const humanBytes = n => (n >= 1024 ? (n/1024).toFixed(0)+' KB' : n+' B');

            const rows = results.map(r => {
              const c = cfgByName.get(r.name) || {};
              const limitStr = c.limit || (typeof r.sizeLimit === 'number' ? humanBytes(r.sizeLimit) : '-');
              const isTime = r.running != null || (typeof limitStr === 'string' && limitStr.endsWith('ms'));
              const valStr = isTime
                ? (r.running != null ? Math.round(r.running * 1000) + ' ms' : 'N/A')
                : (typeof r.size === 'number' ? humanBytes(r.size) : 'N/A');
              const pass = r.passed ? 'âœ…' : 'âŒ';
              return \`| \${r.name} | \${limitStr} | \${valStr} | \${pass} |\`;
            }).join('\n');

            const failed = results.filter(r => !r.passed);
            const status = failed.length ? 'âŒ Some bundles exceed limits' : 'âœ… All bundles are within limits';

            const report = \`# Bundle Analysis Report

          ## ðŸ“Š Size Limit Results

          | Check | Limit | Size | Passed |
          |-------|-------|------|--------|
          \${rows}

          ## ðŸ“‹ Analysis Summary

          - **Total Checks**: \${results.length}
          - **Passed**: \${results.filter(x => x.passed).length}
          - **Failed**: \${failed.length}
          - **Status**: \${status}

          \${failed.length ? \`
          ## ðŸš¨ Failed Checks

          \${failed.map(x => {
            const c = cfgByName.get(x.name) || {};
            const limitStr = c.limit || (typeof x.sizeLimit === 'number' ? humanBytes(x.sizeLimit) : '-');
            const isTime = x.running != null || (typeof limitStr === 'string' && limitStr.endsWith('ms'));
            const valStr = isTime ? (x.running != null ? Math.round(x.running * 1000)+' ms' : 'N/A')
                                  : (typeof x.size === 'number' ? humanBytes(x.size) : 'N/A');
            return \`- **\${x.name}**: \${valStr} (limit: \${limitStr})\`;
          }).join('\n')}

          ## ðŸ› ï¸ Optimization Suggestions

          - Consider code splitting for large bundles
          - Use dynamic imports for non-critical features
          - Optimize third-party dependencies
          - Review and remove unused code
          \` : \`
          ## ðŸŽ‰ All Good!

          Great job keeping your bundles optimized!
          \`}

          ---
          *Generated on \${new Date().toISOString()}*
          *Generated by GitHub Actions Bundle Size Analysis*
          \`;

            fs.writeFileSync('.bundle-analysis/analysis-report.md', report);
            console.log('âœ… Analysis report generated from JSON');
          "

      - name: 'ðŸ”§ Ensure jq'
        run: |
          command -v jq >/dev/null 2>&1 || { sudo apt-get update -y && sudo apt-get install -y jq; }

      - name: 'âœ… Evaluate results'
        id: eval
        working-directory: packages/leenders-coaching-nl
        run: |
          HAS_FAIL=$(jq -r '[.[] | select(.passed==false)] | length > 0' .bundle-analysis/size-results.json)
          echo "has_failures=$HAS_FAIL" >> "$GITHUB_OUTPUT"

      - name: 'ðŸ“Š Generate Delta Comparison'
        if: always() && github.event_name == 'pull_request'
        working-directory: packages/leenders-coaching-nl
        run: |
          if [[ -f ".bundle-analysis/size-results-main.json" && -f ".bundle-analysis/size-results.json" ]]; then
            node -e "
              const fs = require('fs');
              const fmtBytes = n => n.toFixed(0) + ' B';
              const fmtMs = n => n.toFixed(0) + ' ms';
              try {
                const current = JSON.parse(fs.readFileSync('.bundle-analysis/size-results.json', 'utf8'));
                const main = JSON.parse(fs.readFileSync('.bundle-analysis/size-results-main.json', 'utf8'));
                const rows = [];

                for (const item of current) {
                  const base = main.find(m => m.name === item.name);
                  if (!base) continue;

                  const isTime = item.running != null || base.running != null; // âœ… detect time via 'running'
                  const curVal  = isTime ? ((item.running || 0) * 1000) : (item.size || 0);
                  const baseVal = isTime ? ((base.running  || 0) * 1000) : (base.size || 0);
                  const delta = curVal - baseVal;
                  const pct   = baseVal > 0 ? ((delta / baseVal) * 100) : 0;
                  const arrow = delta > 0 ? 'â–²' : delta < 0 ? 'â–¼' : 'â€¢';
                  const unit  = isTime ? 'ms' : 'B';
                  const fmt   = isTime ? fmtMs : fmtBytes;

                  rows.push(\`| \${item.name} | \${fmt(curVal)} | \${fmt(baseVal)} | \${arrow} \${delta.toFixed(0)} \${unit} (\${pct.toFixed(1)}%) |\`);
                }

                if (rows.length) {
                  const md = [
                    '## ðŸ“ˆ Changes vs Main Branch',
                    '',
                    '| Check | Current | Main | Change |',
                    '|-------|---------|------|--------|',
                    ...rows,
                    ''
                  ].join('\\n');
                  fs.writeFileSync('.bundle-analysis/delta-report.md', md);
                  console.log('âœ… Delta comparison generated');
                }
              } catch (e) {
                console.log('âš ï¸ Could not generate delta comparison:', e.message);
              }
            "
          fi

      - name: 'ðŸ“ˆ Append delta to report (if exists)'
        working-directory: packages/leenders-coaching-nl
        run: |
          if [ -f .bundle-analysis/delta-report.md ]; then
            echo "" >> .bundle-analysis/analysis-report.md
            cat .bundle-analysis/delta-report.md >> .bundle-analysis/analysis-report.md
          fi

      - name: 'ðŸ“ Upload Bundle Analysis Artifacts'
        uses: actions/upload-artifact@v4
        with:
          name: 'bundle-analysis-${{ github.run_number }}'
          path: |
            packages/leenders-coaching-nl/.bundle-analysis/
          retention-days: 30

      - name: 'ðŸ’¬ Create PR Comment on Size Limit Failure'
        if: github.event_name == 'pull_request' && steps.eval.outputs.has_failures == 'true'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          header: bundle-size-analysis
          number: ${{ github.event.pull_request.number }}
          path: packages/leenders-coaching-nl/.bundle-analysis/analysis-report.md

      - name: 'ðŸ’¬ Create PR Comment on Size Limit Success'
        if: github.event_name == 'pull_request' && steps.eval.outputs.has_failures != 'true'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          header: bundle-size-analysis
          number: ${{ github.event.pull_request.number }}
          path: packages/leenders-coaching-nl/.bundle-analysis/analysis-report.md

      - name: 'ðŸ“‹ Job Summary'
        if: always()
        shell: bash
        run: |
          {
            echo "## ðŸ“Š Bundle Size Analysis & Limits";
            echo "";
            if [[ -f "packages/leenders-coaching-nl/.bundle-analysis/size-results.json" ]]; then
              echo "### ðŸ“Š Size Limit Results";
              echo "";
              echo "| Check | Limit | Size | Passed |";
              echo "|-------|-------|------|--------|";
              jq -s -r '
                # $r = results, $c = config; join by .name
                (.[0] // []) as $r
                | (.[1] // []) as $c
                | ($c | map({key:.name, val:.limit}) | from_entries) as $limits
                | $r[]
                | . as $x
                | "| \($x.name) | \($limits[$x.name] // (if (.sizeLimit!=null) then (.sizeLimit|tostring+" B") else "-" end)) | " +
                  ( if ($x.running!=null) then ((($x.running*1000)|floor|tostring) + " ms")
                    else (($x.size // 0 | tostring) + " B") end ) + " | " +
                  (if $x.passed then "âœ…" else "âŒ" end) + " |"
              ' packages/leenders-coaching-nl/.bundle-analysis/size-results.json packages/leenders-coaching-nl/.size-limit.json;
              echo "";
              echo "### ðŸ“‹ Analysis Results";
              echo "Check the workflow artifacts for detailed information about your bundle sizes.";
            else
              echo "### ðŸ“‹ Analysis Results";
              echo "Size limit results not available. Check the workflow logs for details.";
            fi
            echo "";
            echo "### ðŸ“ Artifacts";
            echo "Download the bundle analysis artifacts to see the detailed report.";
          } >> $GITHUB_STEP_SUMMARY
