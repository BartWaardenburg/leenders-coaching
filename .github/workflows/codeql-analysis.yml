name: 'CodeQL Security Analysis'

on:
  push:
    branches: ['main', 'develop']
  pull_request:
    branches: ['main', 'develop']
  schedule:
    - cron: '0 0 * * 1'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  actions: read
  contents: read
  security-events: write
  pull-requests: write
  issues: write

env:
  NODE_VERSION: '22'
  PNPM_VERSION: '10.15.1'
  PNPM_HOME: /home/runner/.local/share/pnpm

jobs:
  codeql-analysis:
    name: 'CodeQL Security Analysis'
    runs-on: ubuntu-latest
    timeout-minutes: 360

    strategy:
      fail-fast: false
      matrix:
        language: ['javascript']

    steps:
      - name: '🔄 Checkout repository'
        uses: actions/checkout@v5

      - name: '🔧 Initialize CodeQL'
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality
          config-file: ./.github/codeql/codeql-config.yml

      - name: '🔨 Autobuild'
        uses: github/codeql-action/autobuild@v3

      - name: '🔍 Perform CodeQL Analysis'
        uses: github/codeql-action/analyze@v3
        with:
          category: '/language:${{matrix.language}}'

  security-checks:
    name: 'Security & Quality Checks'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: codeql-analysis

    steps:
      - name: '🔄 Checkout repository'
        uses: actions/checkout@v5

      - name: '🔧 Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: '📦 Setup pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: 'Get pnpm store path'
        run: echo "PNPM_STORE_PATH=$(pnpm store path)" >> $GITHUB_ENV

      - name: '💾 Cache pnpm store'
        uses: actions/cache@v4
        with:
          path: ${{ env.PNPM_STORE_PATH }}
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: '📥 Install dependencies'
        run: pnpm run ci:install:frozen

      - name: '🔒 Run security audit'
        run: pnpm run ci:security

      - name: '📦 Check for outdated dependencies'
        run: pnpm outdated || true

      - name: '🔍 Run type checking'
        run: pnpm run type-check

      - name: '🧹 Run linting'
        run: pnpm run lint

      - name: '🔗 Check for broken links in documentation'
        run: |
          find . -name "*.md" -not -path "./node_modules/*" -not -path "./.next/*" -not -path "./packages/*/node_modules/*" | \
          head -5 | \
          xargs -I {} echo "Would check: {}" || true

      - name: '🔐 Check for environment variable usage'
        run: |
          grep -r "password\|secret\|key\|token" packages/leenders-coaching-nl/src --include="*.ts" --include="*.tsx" | \
          grep -v "process.env" | \
          grep -v "NEXT_PUBLIC" | \
          head -10 || true

      - name: '⚠️ Check for unsafe patterns'
        run: |
          grep -r "eval(" packages/leenders-coaching-nl/src --include="*.ts" --include="*.tsx" || echo "No eval usage found"

          grep -r "innerHTML\|dangerouslySetInnerHTML" packages/leenders-coaching-nl/src --include="*.ts" --include="*.tsx" || echo "No innerHTML usage found"

          grep -r "console\.log" packages/leenders-coaching-nl/src --include="*.ts" --include="*.tsx" | \
          grep -v "//.*console\.log" | \
          head -5 || echo "No console.log usage found"

      - name: '📝 Check for TypeScript best practices'
        run: |
          grep -r ": any" packages/leenders-coaching-nl/src --include="*.ts" --include="*.tsx" | \
          head -10 || echo "No 'any' types found"

      - name: '🛡️ Check for security headers and configurations'
        run: |
          grep -r "helmet" packages/leenders-coaching-nl/src --include="*.ts" --include="*.tsx" || echo "No Helmet usage found"

          grep -r "cors" packages/leenders-coaching-nl/src --include="*.ts" --include="*.tsx" || echo "No CORS configuration found"

          grep -r "rate.*limit\|throttle" packages/leenders-coaching-nl/src --include="*.ts" --include="*.tsx" || echo "No rate limiting found"

      - name: '🔑 Check for authentication and authorization patterns'
        run: |
          grep -r "jwt\|jsonwebtoken" packages/leenders-coaching-nl/src --include="*.ts" --include="*.tsx" || echo "No JWT usage found"

          grep -r "session\|cookie" packages/leenders-coaching-nl/src --include="*.ts" --include="*.tsx" | \
          grep -v "console" | \
          head -5 || echo "No session management found"

      - name: '✅ Check for input validation patterns'
        run: |
          grep -r "zod\|joi\|yup\|validator" packages/leenders-coaching-nl/src --include="*.ts" --include="*.tsx" || echo "No validation libraries found"

          grep -r "sanitize\|escape\|encode" packages/leenders-coaching-nl/src --include="*.ts" --include="*.tsx" | \
          head -5 || echo "No sanitization found"

      - name: '📁 Check for file upload security'
        run: |
          grep -r "multer\|upload\|file.*upload" packages/leenders-coaching-nl/src --include="*.ts" --include="*.tsx" || echo "No file upload handling found"

      - name: '🗄️ Check for database security'
        run: |
          grep -r "prepared.*statement\|parameterized\|query.*params" packages/leenders-coaching-nl/src --include="*.ts" --include="*.tsx" || echo "No SQL injection prevention found"

      - name: '📊 Create comprehensive security report'
        if: always()
        run: |
          cat > security-report.sarif << 'EOF'
          {
            "$schema": "https://schemastore.azurewebsites.net/schemas/json/sarif-2.1.0-rtm.5.json",
            "version": "2.1.0",
            "runs": [
              {
                "tool": {
                  "driver": {
                    "name": "Next.js Security Checker",
                    "version": "1.0.0",
                    "informationUri": "https://github.com/actions/codeql-action"
                  }
                },
                "results": []
              }
            ]
          }
          EOF

      - name: '📤 Upload security report'
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: security-report.sarif

  pr-comment:
    name: 'PR Comment (Security & Quality)'
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [codeql-analysis, security-checks]
    permissions:
      pull-requests: write
      issues: write
    steps:
      - name: '💬 Sticky PR comment – CodeQL & Checks'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          header: codeql-quality
          number: ${{ github.event.pull_request.number }}
          message: |
            ## 🛡️ Security & Quality (summary)
            - **CodeQL Analysis:** ${{ needs.codeql-analysis.result == 'success' && '✅ Completed' || '❌ Failed' }}
            - **Security/Quality Checks:** ${{ needs.security-checks.result == 'success' && '✅ Completed' || '❌ Failed' }}
            - SARIF uploaded to the **Security** tab.

            *Generated by GitHub Actions CodeQL*
