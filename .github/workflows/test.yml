name: 'Reusable Test Workflow'

on:
  workflow_call:
    inputs:
      test-command:
        description: 'Test command to run'
        required: false
        default: 'ci:test'
        type: string
      quality-command:
        description: 'Quality check command to run'
        required: false
        default: 'ci:quality'
        type: string
      security-command:
        description: 'Security check command to run'
        required: false
        default: 'ci:security'
        type: string
      coverage-upload:
        description: 'Whether to upload coverage reports'
        required: false
        default: true
        type: boolean
      working-directory:
        description: 'Working directory for the job'
        required: false
        default: ''
        type: string
    secrets:
      CODECOV_TOKEN:
        required: false
      NEXT_PUBLIC_SANITY_PROJECT_ID:
        required: false
      NEXT_PUBLIC_SANITY_DATASET:
        required: false
      NEXT_PUBLIC_SANITY_API_VERSION:
        required: false
      SANITY_API_TOKEN:
        required: false
      RESEND_API_KEY:
        required: false

jobs:
  test:
    name: 'Run Tests'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
      NEXT_PUBLIC_SANITY_DATASET: ${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}
      NEXT_PUBLIC_SANITY_API_VERSION: ${{ secrets.NEXT_PUBLIC_SANITY_API_VERSION }}
      SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}

    steps:
      - name: 'ğŸ”„ Checkout repository'
        uses: actions/checkout@v5

      - name: 'ğŸ”§ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: 'ğŸ“¦ Setup pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: '10.15.1'
          run_install: false

      - name: 'Get pnpm store path'
        run: echo "PNPM_STORE_PATH=$(pnpm store path)" >> $GITHUB_ENV

      - name: 'ğŸ’¾ Cache pnpm store'
        uses: actions/cache@v4
        with:
          path: ${{ env.PNPM_STORE_PATH }}
          key: pnpm-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-${{ runner.os }}-

      - name: 'ğŸ“¥ Install dependencies'
        working-directory: ${{ inputs.working-directory }}
        run: pnpm run ci:install:frozen

      - name: 'ğŸ”’ Run security audit'
        if: ${{ inputs.security-command != '' }}
        working-directory: ${{ inputs.working-directory }}
        run: pnpm run ${{ inputs.security-command }}
        continue-on-error: true

      - name: 'ğŸ” Quality checks'
        if: ${{ inputs.quality-command != '' }}
        working-directory: ${{ inputs.working-directory }}
        run: pnpm run ${{ inputs.quality-command }}

      - name: 'ğŸ§ª Run comprehensive tests'
        working-directory: ${{ inputs.working-directory }}
        run: pnpm run ${{ inputs.test-command }}

      - name: 'ğŸ“Š Upload coverage to Codecov'
        if: ${{ inputs.coverage-upload }}
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: ./packages/leenders-coaching-nl/coverage
          fail_ci_if_error: false
          verbose: true
          flags: frontend

      - name: 'ğŸ“¤ Upload test results'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.sha }}
          path: |
            packages/leenders-coaching-nl/coverage/
            packages/leenders-coaching-nl/test-results/
          retention-days: 30
